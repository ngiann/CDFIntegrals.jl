# Following equations taken from Frey and Hinton, 
# Variational Learning in Nonlinear Gaussian Belief Networks,1998
#
# https://www.cs.toronto.edu/~hinton/absps/nlgbn.pdf
#


#----------------------------------------------#
# Considering x âˆ¼ N(Î¼, Ïƒ)                      #
# M stands for the expectation of Î¦(x)         #
# V stands for the variance of Î¦(x)            #
# B stands for the expectation of [Î¦(x)]Â²      #
#----------------------------------------------#


#--------------------------------------------------------------[1]-#
# Expectation âˆ« N(x|Î¼, Ïƒ) Î¦(x) dx                                  #
#------------------------------------------------------------------#

M(Î¼, Ïƒ) = Î¦(Î¼/sqrt(1+Ïƒ^2))


#--------------------------------------------------------------[2]-#
# Expectation âˆ« N(x|Î¼, Ïƒ) Î¦(x*s) dx                                #
#------------------------------------------------------------------#

M(Î¼, Ïƒ, s) = M(Î¼*s, Ïƒ*s)


#--------------------------------------------------------------[3]-#
# Expectation âˆ« N(x|Î¼, Ïƒ) (Î¦(x) - M(Î¼,Ïƒ))Â² dx                      #
#------------------------------------------------------------------#

V(Î¼, Ïƒ) = J(Î¼, Ïƒ) - M(Î¼, Ïƒ)^2


#--------------------------------------------------------------[4]-#
# Expectation âˆ« N(x|Î¼, Ïƒ) [Î¦(x)]Â² dx                               #
#------------------------------------------------------------------#

B(Î¼, Ïƒ) = J(Î¼, Ïƒ)


#--------------------------------------------------------------[5]-#
# Expectation âˆ« N(x|Î¼, Ïƒ) [Î¦(x*s)]Â² dx                             #
#------------------------------------------------------------------#

B(Î¼, Ïƒ, s) = B(Î¼*s, Ïƒ*s)



#------------------------------------------------#
# MM  stands for the expectation of M(x, s)      #
# MMÂ² stands for the expectation of [M(x, s)]Â²   #
#------------------------------------------------#


#--------------------------------------------------------------[6]-#
# Expectation âˆ« N(x|Î¼, Ïƒ) M(x, s) dx                               #
#                                                                  #
# where M(x,s) = Î¦(x/sqrt(1+s^2))                                  #
#------------------------------------------------------------------#

function MM(Î¼, Ïƒ, s)
   
    scale = sqrt(1+s^2)

    M(Î¼, Ïƒ,  1/scale)

end


#--------------------------------------------------------------[7]-#
# Expectation of âˆ« N(ğ±|ğ›, ğšº) M(ğ¯áµ€ğ±, s) ğğ±                          #
#                                                                  #
# where M(â–¡,s) = Î¦(â–¡/sqrt(1+s^2))                                  #
#------------------------------------------------------------------#

function MM(Î¼, Î£, s, v)
    
    scale = sqrt(1+s^2)
    
    M(dot(v, Î¼), sqrt(dot(v, Î£*v)), 1/scale) # consult Barber, Eq. (28.5.8)
    
end


#--------------------------------------------------------------[8]-#
# Expectation                                                      # 
# âˆ« N(x|Î¼, Ïƒ) [M(x, s)]Â² dx = âˆ« N(x|Î¼, Ïƒ) [Î¦(x/sqrt(1+s^2))]Â² dx   #
#------------------------------------------------------------------#

function MMÂ²(Î¼, Ïƒ, s)
   
    scale = sqrt(1+s^2)

    B(Î¼, Ïƒ, 1/scale)

end


#--------------------------------------------------------------[9]-#
# Expectation âˆ« N(x|Î¼, Î£) [M(váµ€x, s)]Â² dx                          #
#           = âˆ« N(x|Î¼, Î£) [B(váµ€x, s)]  dx                          #
#------------------------------------------------------------------#

MMÂ²(Î¼, Î£, s, v) = MMÂ²(dot(v, Î¼), sqrt(dot(v, Î£*v)), s)


#-------------------------------------------------------------[10]-#
# Expectation of âˆ« N(x|Î¼, Î£) [B(váµ€x, s)] dx                        #
#------------------------------------------------------------------#

# This is equivalent to MMÂ²(Î¼, Î£, s, v) in [9].
# Keep for verification purposes.

function BB(Î¼, Î£, s, v)
   
    scale = sqrt(1+s^2)

    B(dot(v, Î¼), sqrt(dot(v, Î£*v)), 1/scale)

end


#-------------------------------------------------------------[11]-#
# Upper bound to variance of âˆ« N(x| Î¼, Ïƒ) â‹… (Î¦(x) - M(Î¼, Ïƒ))Â² dx   #
#------------------------------------------------------------------#

function Vup(Î¼, Ïƒ) 
    
    MÎ¼Ïƒ = M(Î¼, Ïƒ)

    MÎ¼Ïƒ * (1-MÎ¼Ïƒ) * (Ïƒ^2/(Ïƒ^2 + Ï€/2)) # note: part of the expression in Bup(Î¼, Ïƒ)

end


#-------------------------------------------------------------[12]-#
# Upper bound to expectation of square âˆ« N(x|Î¼, Ïƒ) [Î¦(x)]Â² dx      #
#------------------------------------------------------------------#

function Bup(Î¼, Ïƒ) 
    
    MÎ¼Ïƒ = M(Î¼, Ïƒ)

    MÎ¼Ïƒ * ( (1-MÎ¼Ïƒ) * (Ïƒ^2/(Ïƒ^2 + Ï€/2)) + MÎ¼Ïƒ ) 

end




# * * * * * * * * #
#      UNUSED     #
# * * * * * * * * #

# #----------------------------------------------------------------------#
# # Convenience function that returns both M(Î¼, Ïƒ) and B(Î¼, Ïƒ) in one go #
# #----------------------------------------------------------------------#

# function MB(Î¼, Ïƒ) 
    
#     ÏƒÂ² = Ïƒ^2

#     MÎ¼Ïƒ = Î¦(Î¼/sqrt(1+ÏƒÂ²))

#     BÎ¼Ïƒ = MÎ¼Ïƒ * ( (1-MÎ¼Ïƒ) * (ÏƒÂ²/(ÏƒÂ² + Ï€/2)) + MÎ¼Ïƒ ) 

#     MÎ¼Ïƒ, BÎ¼Ïƒ

# end


# #----------------------------------------------------------------------------#
# # Approximate, faster version of Î¦ and MB                                    #
# # Constant 1.7009913570613704 obtained from calculate_approximate_to_normcdf #
# #----------------------------------------------------------------------------#

# # sigm(x) = 1.0 / (1.0 + exp(-x))

# # Î¦approx(x) = sigm(x * 1.7009913570613704) 

# Î¦approx(x) = 1.0 / (1.0 + exp(-x*1.7009913570613704)) 

# function MBapprox(Î¼, Ïƒ) 
    
#     ÏƒÂ² = Ïƒ^2

#     MÎ¼Ïƒ = Î¦approx(Î¼/sqrt(1+ÏƒÂ²))

#     BÎ¼Ïƒ = MÎ¼Ïƒ * ( (1-MÎ¼Ïƒ) * (ÏƒÂ²/(ÏƒÂ² + Ï€/2)) + MÎ¼Ïƒ ) 

#     MÎ¼Ïƒ, BÎ¼Ïƒ

# end